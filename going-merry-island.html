<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Going Merry Island View</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #info-panel {
            position: absolute;
            right: 20px;
            top: 20px;
            width: 300px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            display: none;
            z-index: 100;
        }
        #island-image {
            width: 100%;
            height: 150px;
            background-color: #3498db;
            margin-bottom: 10px;
            background-image: url('/api/placeholder/300/150');
            background-size: cover;
            border-radius: 5px;
        }
        #island-description {
            font-size: 14px;
            line-height: 1.4;
        }
        #controls-info {
            position: absolute;
            left: 20px;
            bottom: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
        }
        #start-screen {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #start-button {
            padding: 15px 30px;
            font-size: 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #start-instructions {
            color: white;
            text-align: center;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="start-screen">
        <div>
            <div id="start-instructions">
                <h2>Going Merry Island Adventure</h2>
                <p>Controls:<br>
                W, A, S, D - Move around<br>
                Arrow keys - Look around</p>
            </div>
            <button id="start-button">Start Adventure</button>
        </div>
    </div>
    
    <div id="info-panel">
        <div id="island-image"></div>
        <div id="island-description">
            Welcome to Katori Island! This lush tropical paradise is known for its dense forests, pristine beaches, and mysterious ancient ruins. Legend says a great treasure is hidden somewhere on this island. The locals are friendly but wary of pirates.
        </div>
    </div>
    
    <div id="controls-info">
        W, A, S, D - Move | Arrow Keys - Look around
    </div>

    <script>
        // Main Three.js variables
        let scene, camera, renderer;
        let moveForward = false;
        let moveBackward = false;
        let moveLeft = false;
        let moveRight = false;
        let lookUp = false;
        let lookDown = false;
        let lookLeft = false;
        let lookRight = false;
        let velocity = new THREE.Vector3();
        let islandMesh;
        let infoPanel;
        let lookingAtIsland = false;
        let gameStarted = false;
        
        // Camera controls
        let cameraRotation = {
            x: 0,
            y: 0
        };
        
        // Initialize the scene
        function init() {
            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB); // Sky blue
            scene.fog = new THREE.FogExp2(0x87CEEB, 0.005);
            
            // Camera setup - positioned to the left of the sheep's head at the front of the ship
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 1000);
            camera.position.set(6, 15, 18); // Positioned to the left of the figurehead
            // Set initial camera rotation to look back at the ship
            cameraRotation.y = Math.PI; // Looking backward (toward the ship)
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 2);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(1, 1, 0.5).normalize();
            scene.add(directionalLight);
            
            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);
            
            // Key controls
            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);
            
            // Info panel
            infoPanel = document.getElementById('info-panel');
            
            // Create objects in the scene
            createObjects();
            
            // Handle window resize
            window.addEventListener('resize', onWindowResize);
            
            // Start screen
            const startScreen = document.getElementById('start-screen');
            const startButton = document.getElementById('start-button');
            
            startButton.addEventListener('click', () => {
                startScreen.style.display = 'none';
                gameStarted = true;
            });
        }
        
        // Handle key down events
        function onKeyDown(event) {
            if (!gameStarted) return;
            
            switch(event.code) {
                case 'ArrowUp':
                    lookUp = true;
                    break;
                case 'ArrowDown':
                    lookDown = true;
                    break;
                case 'ArrowLeft':
                    lookLeft = true;
                    break;
                case 'ArrowRight':
                    lookRight = true;
                    break;
                case 'KeyW':
                    moveForward = true;
                    break;
                case 'KeyA':
                    moveLeft = true;
                    break;
                case 'KeyS':
                    moveBackward = true;
                    break;
                case 'KeyD':
                    moveRight = true;
                    break;
            }
        }
        
        // Handle key up events
        function onKeyUp(event) {
            if (!gameStarted) return;
            
            switch(event.code) {
                case 'ArrowUp':
                    lookUp = false;
                    break;
                case 'ArrowDown':
                    lookDown = false;
                    break;
                case 'ArrowLeft':
                    lookLeft = false;
                    break;
                case 'ArrowRight':
                    lookRight = false;
                    break;
                case 'KeyW':
                    moveForward = false;
                    break;
                case 'KeyA':
                    moveLeft = false;
                    break;
                case 'KeyS':
                    moveBackward = false;
                    break;
                case 'KeyD':
                    moveRight = false;
                    break;
            }
        }
        
        // Create objects for the scene
        function createObjects() {
            // Create ocean
            const oceanGeometry = new THREE.PlaneGeometry(2000, 2000, 20, 20);
            oceanGeometry.rotateX(-Math.PI / 2);
            
            const oceanMaterial = new THREE.MeshStandardMaterial({
                color: 0x0077be,
                transparent: true,
                opacity: 0.8,
                side: THREE.DoubleSide
            });
            
            const ocean = new THREE.Mesh(oceanGeometry, oceanMaterial);
            ocean.position.y = 0;
            scene.add(ocean);
            
            // Create island in front of the ship (positive Z)
            const islandGeometry = new THREE.ConeGeometry(100, 50, 5);
            const islandMaterial = new THREE.MeshStandardMaterial({ color: 0x228B22 });
            islandMesh = new THREE.Mesh(islandGeometry, islandMaterial);
            islandMesh.position.set(0, -25, 150); // Position island ahead of ship
            islandMesh.name = "island";
            scene.add(islandMesh);
            
            // Create sand around island
            const sandGeometry = new THREE.CircleGeometry(110, 32);
            const sandMaterial = new THREE.MeshStandardMaterial({ color: 0xc2b280 });
            const sand = new THREE.Mesh(sandGeometry, sandMaterial);
            sand.rotation.x = -Math.PI / 2;
            sand.position.set(0, 0.1, 150); // Slightly above water
            scene.add(sand);
            
            // Add some palm trees
            for (let i = 0; i < 10; i++) {
                const angle = Math.random() * Math.PI * 2;
                const radius = Math.random() * 70 + 20;
                const x = Math.cos(angle) * radius;
                const z = Math.sin(angle) * radius + 150;
                
                createPalmTree(x, 0, z);
            }
            
            // Create the Going Merry ship
            createGoingMerry();
        }
        
        // Create a simple palm tree
        function createPalmTree(x, y, z) {
            // Trunk
            const trunkGeometry = new THREE.CylinderGeometry(1, 1.5, 15, 8);
            const trunkMaterial = new THREE.MeshStandardMaterial({ color: 0x8B4513 });
            const trunk = new THREE.Mesh(trunkGeometry, trunkMaterial);
            trunk.position.set(x, y + 7.5, z);
            scene.add(trunk);
            
            // Leaves
            const leavesGeometry = new THREE.ConeGeometry(7, 10, 8);
            const leavesMaterial = new THREE.MeshStandardMaterial({ color: 0x00FF00 });
            const leaves = new THREE.Mesh(leavesGeometry, leavesMaterial);
            leaves.position.set(x, y + 20, z);
            scene.add(leaves);
        }
        
        // Create a more detailed version of the Going Merry from One Piece
        function createGoingMerry() {
            // Ship Group
            const ship = new THREE.Group();
            
            // Hull - main body
            const hullGeometry = new THREE.BoxGeometry(20, 10, 40);
            const hullMaterial = new THREE.MeshStandardMaterial({ color: 0xDEB887 });
            const hull = new THREE.Mesh(hullGeometry, hullMaterial);
            hull.position.y = 5;
            ship.add(hull);
            
            // Main Deck
            const mainDeckGeometry = new THREE.BoxGeometry(18, 1, 38);
            const deckMaterial = new THREE.MeshStandardMaterial({ color: 0xD2B48C });
            const mainDeck = new THREE.Mesh(mainDeckGeometry, deckMaterial);
            mainDeck.position.y = 10.5;
            ship.add(mainDeck);
            
            // Rear Elevated Deck (Quarter Deck)
            const rearDeckGeometry = new THREE.BoxGeometry(18, 1, 12);
            const rearDeck = new THREE.Mesh(rearDeckGeometry, deckMaterial);
            rearDeck.position.set(0, 14.5, -13);
            ship.add(rearDeck);
            
            // Main Cabin
            const cabinGeometry = new THREE.BoxGeometry(14, 8, 10);
            const cabinMaterial = new THREE.MeshStandardMaterial({ color: 0xA0522D });
            const cabin = new THREE.Mesh(cabinGeometry, cabinMaterial);
            cabin.position.set(0, 15, -8);
            ship.add(cabin);
            
            // Captain's Quarters (rear)
            const captainQuartersGeometry = new THREE.BoxGeometry(14, 6, 6);
            const captainQuarters = new THREE.Mesh(captainQuartersGeometry, cabinMaterial);
            captainQuarters.position.set(0, 18, -14);
            ship.add(captainQuarters);
            
            // Windows for cabin
            for (let i = -1; i <= 1; i++) {
                const windowGeometry = new THREE.CircleGeometry(1, 12);
                const windowMaterial = new THREE.MeshStandardMaterial({ color: 0x87CEEB });
                const window = new THREE.Mesh(windowGeometry, windowMaterial);
                window.position.set(i * 4, 15, -3);
                window.rotation.y = Math.PI;
                ship.add(window);
            }
            
            // Main Mast
            const mastGeometry = new THREE.CylinderGeometry(0.8, 1, 30, 8);
            const mastMaterial = new THREE.MeshStandardMaterial({ color: 0x8B4513 });
            const mast = new THREE.Mesh(mastGeometry, mastMaterial);
            mast.position.set(0, 25, 2);
            ship.add(mast);
            
            // Crow's Nest
            const crowsNestGeometry = new THREE.CylinderGeometry(2.5, 2.5, 2, 8);
            const crowsNestMaterial = new THREE.MeshStandardMaterial({ color: 0x8B4513 });
            const crowsNest = new THREE.Mesh(crowsNestGeometry, crowsNestMaterial);
            crowsNest.position.set(0, 35, 2);
            ship.add(crowsNest);
            
            // Main Sail
            const mainSailGeometry = new THREE.PlaneGeometry(15, 20);
            const sailMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xFFFFFF,
                side: THREE.DoubleSide
            });
            const mainSail = new THREE.Mesh(mainSailGeometry, sailMaterial);
            mainSail.position.set(0, 25, 2);
            mainSail.rotation.y = Math.PI / 2;
            ship.add(mainSail);
            
            // Straw Hat Jolly Roger on sail
            const logoGeometry = new THREE.CircleGeometry(3, 16);
            const logoMaterial = new THREE.MeshStandardMaterial({ color: 0xFF0000 });
            const logo = new THREE.Mesh(logoGeometry, logoMaterial);
            logo.position.set(0.1, 25, 2);
            logo.rotation.y = Math.PI / 2;
            ship.add(logo);
            
            // Ship railings
            const railingMaterial = new THREE.MeshStandardMaterial({ color: 0x8B4513 });
            
            // Front railings
            for (let i = -1; i <= 1; i += 0.5) {
                const postGeometry = new THREE.CylinderGeometry(0.3, 0.3, 3, 6);
                const post = new THREE.Mesh(postGeometry, railingMaterial);
                post.position.set(i * 8, 12, 14);
                ship.add(post);
            }
            
            // Side railings
            for (let i = -4; i <= 4; i++) {
                // Left side
                const leftPost = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.3, 3, 6), railingMaterial);
                leftPost.position.set(-9, 12, i * 4);
                ship.add(leftPost);
                
                // Right side
                const rightPost = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.3, 3, 6), railingMaterial);
                rightPost.position.set(9, 12, i * 4);
                ship.add(rightPost);
            }
            
            // Horizontal railings
            const sideRailingGeometry = new THREE.BoxGeometry(18, 0.4, 0.4);
            const frontRailingGeometry = new THREE.BoxGeometry(0.4, 0.4, 38);
            
            const leftRailing = new THREE.Mesh(frontRailingGeometry, railingMaterial);
            leftRailing.position.set(-9, 13, 0);
            ship.add(leftRailing);
            
            const rightRailing = new THREE.Mesh(frontRailingGeometry, railingMaterial);
            rightRailing.position.set(9, 13, 0);
            ship.add(rightRailing);
            
            const frontRailing = new THREE.Mesh(sideRailingGeometry, railingMaterial);
            frontRailing.position.set(0, 13, 19);
            ship.add(frontRailing);
            
            // Tangerine Trees (Nami's grove)
            for (let i = 0; i < 3; i++) {
                // Tree pot
                const potGeometry = new THREE.CylinderGeometry(0.8, 0.6, 1.5, 8);
                const potMaterial = new THREE.MeshStandardMaterial({ color: 0x8B4513 });
                const pot = new THREE.Mesh(potGeometry, potMaterial);
                pot.position.set(-5 + i * 2, 11.5, -14);
                ship.add(pot);
                
                // Tree foliage
                const foliageGeometry = new THREE.SphereGeometry(1.2, 8, 8);
                const foliageMaterial = new THREE.MeshStandardMaterial({ color: 0x228B22 });
                const foliage = new THREE.Mesh(foliageGeometry, foliageMaterial);
                foliage.position.set(-5 + i * 2, 13.5, -14);
                ship.add(foliage);
                
                // Tangerines
                for (let j = 0; j < 3; j++) {
                    const tangerineGeometry = new THREE.SphereGeometry(0.2, 8, 8);
                    const tangerineMaterial = new THREE.MeshStandardMaterial({ color: 0xFFA500 });
                    const tangerine = new THREE.Mesh(tangerineGeometry, tangerineMaterial);
                    tangerine.position.set(-5 + i * 2 + (Math.random() - 0.5) * 0.8, 
                                          13.5 + (Math.random() - 0.5) * 0.8, 
                                          -14 + (Math.random() - 0.5) * 0.8);
                    ship.add(tangerine);
                }
            }
            
            // Anchor
            const anchorGeometry = new THREE.BoxGeometry(1, 3, 0.5);
            const anchorMaterial = new THREE.MeshStandardMaterial({ color: 0x696969 });
            const anchor = new THREE.Mesh(anchorGeometry, anchorMaterial);
            anchor.position.set(-9.5, 8, 5);
            ship.add(anchor);
            
            // Sheep figurehead (more detailed)
            const headGeometry = new THREE.SphereGeometry(3, 12, 12);
            const woolMaterial = new THREE.MeshStandardMaterial({ color: 0xFFFFFF });
            const head = new THREE.Mesh(headGeometry, woolMaterial);
            head.position.set(0, 13, 20);
            ship.add(head);
            
            // Sheep horns
            const hornGeometry = new THREE.CylinderGeometry(0.4, 0.2, 3, 8);
            const hornMaterial = new THREE.MeshStandardMaterial({ color: 0xF5DEB3 });
            
            const leftHorn = new THREE.Mesh(hornGeometry, hornMaterial);
            leftHorn.position.set(-1.5, 15, 19);
            leftHorn.rotation.z = -Math.PI / 4;
            ship.add(leftHorn);
            
            const rightHorn = new THREE.Mesh(hornGeometry, hornMaterial);
            rightHorn.position.set(1.5, 15, 19);
            rightHorn.rotation.z = Math.PI / 4;
            ship.add(rightHorn);
            
            // Sheep eyes
            const eyeGeometry = new THREE.SphereGeometry(0.4, 8, 8);
            const eyeMaterial = new THREE.MeshStandardMaterial({ color: 0x000000 });
            
            const leftEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
            leftEye.position.set(-1.5, 13, 22);
            ship.add(leftEye);
            
            const rightEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
            rightEye.position.set(1.5, 13, 22);
            ship.add(rightEye);
            
            // Position the whole ship
            ship.position.set(0, 0, 0);
            scene.add(ship);
        }
        
        // Handle window resizing
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        // Check if player is looking toward the island (with wider angle)
        function checkLookingAtIsland() {
            // Get direction vector from camera to island
            const islandPosition = new THREE.Vector3(0, 0, 150);
            const directionToIsland = new THREE.Vector3();
            directionToIsland.subVectors(islandPosition, camera.position);
            directionToIsland.normalize();
            
            // Get camera's forward direction
            const cameraDirection = new THREE.Vector3(0, 0, -1);
            cameraDirection.applyQuaternion(camera.quaternion);
            
            // Calculate dot product (cosine of angle between vectors)
            const dotProduct = cameraDirection.dot(directionToIsland);
            
            // If dot product is > 0.7, camera is looking roughly toward the island
            // (corresponds to about a 45 degree cone)
            let newLookingAtIsland = (dotProduct > 0.7);
            
            // Only update display if state changed
            if (newLookingAtIsland !== lookingAtIsland) {
                lookingAtIsland = newLookingAtIsland;
                infoPanel.style.display = lookingAtIsland ? 'block' : 'none';
            }
        }
        
        // Update camera rotation based on key input
        function updateCameraRotation() {
            if (lookUp) cameraRotation.x += 0.03;
            if (lookDown) cameraRotation.x -= 0.03;
            if (lookLeft) cameraRotation.y += 0.03;
            if (lookRight) cameraRotation.y -= 0.03;
            
            // Limit vertical rotation to avoid flipping
            cameraRotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, cameraRotation.x));
            
            // Apply rotation
            camera.rotation.x = cameraRotation.x;
            camera.rotation.y = cameraRotation.y;
        }
        
        // Update camera position based on key input
        function updateCameraPosition() {
            const speed = 0.8;
            const moveVector = new THREE.Vector3();
            
            if (moveForward) {
                moveVector.z -= Math.cos(cameraRotation.y) * speed;
                moveVector.x -= Math.sin(cameraRotation.y) * speed;
            }
            if (moveBackward) {
                moveVector.z += Math.cos(cameraRotation.y) * speed;
                moveVector.x += Math.sin(cameraRotation.y) * speed;
            }
            if (moveLeft) {
                moveVector.x -= Math.cos(cameraRotation.y) * speed;
                moveVector.z += Math.sin(cameraRotation.y) * speed;
            }
            if (moveRight) {
                moveVector.x += Math.cos(cameraRotation.y) * speed;
                moveVector.z -= Math.sin(cameraRotation.y) * speed;
            }
            
            // Apply movement
            camera.position.add(moveVector);
            
            // Keep player on the ship
            const shipBoundary = {
                minX: -9,
                maxX: 9,
                minZ: -19,
                maxZ: 19
            };
            
            camera.position.x = Math.max(shipBoundary.minX, Math.min(shipBoundary.maxX, camera.position.x));
            camera.position.z = Math.max(shipBoundary.minZ, Math.min(shipBoundary.maxZ, camera.position.z));
            
            // Keep player at deck level
            camera.position.y = 15;
        }
        
        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            
            if (gameStarted) {
                // Update camera rotation
                updateCameraRotation();
                
                // Update camera position
                updateCameraPosition();
                
                // Check if looking at island
                checkLookingAtIsland();
            }
            
            renderer.render(scene, camera);
        }
        
        // Initialize and start animation
        init();
        animate();
    </script>
</body>
</html>